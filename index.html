<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>myMemoPad</title>
    <!-- <script src="js/jquery-2.1.3.min.js"></script> -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/sample.css">
</head>
<!-- 理想 -->
<body style="display:none;">
    <!-- ヘッダー部分について、記録してある数を表示する工夫があってもいいかも -->
    <!-- 最後にyoutube動画はちゃんと見てもいいかも -->
    <header>
        <h1 id="h1">メモ帳</h1>
    </header>

    <main>
        <div class="memo" id="memo">
            <textarea class="name" id="name" placeholder="氏名" cols="15" rows="1" maxlength="15"></textarea>
            <div class="midashi" id="midashi">
                <textarea class="title" id="title" placeholder="タイトル" cols="30" rows="1" maxlength="15"></textarea>
                <select class="kind" id="kind" name="kind">
                    <option hidden>種別選択</option>
                    <option value="メモ">メモ</option>
                    <option value="お絵かき">お絵かき</option>
                </select>
                <!-- メニューバーから外し、セレクトボックスを統一する -->
                <select class="back" id="back_menu" name="back">
                    <option hidden>メモ一覧</option>
                </select>
                <select class="back" id="canvas_back_menu" name="back">
                    <option hidden>お絵かき一覧</option>
                </select>
            </div>
            <div class="detail" id="detail">
            <textarea class="text_area" id="text_area" placeholder="入力はこちらです"></textarea>
            </div>
        </div>
        <ul id="menu_bar">
            <!-- ここには別のところから差し込む -->
        </ul>
    </main>
    <!-- footerの調整は最後の最後でいい、項目が押されると何かアクションがあってもいいかも -->
    <!-- <footer><small>memo&&oekaki@gs.academy.jp</small></footer> -->

    <!-- jQueryの読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- jQueryの記述 -->
    <script>
        // 課題
        // resetする時にはoptionを破棄する
        // option選択後、もしくは何かしらのタイミングにおいて初期値に戻す

        // 初期設定する変数などはこちらで
        let save_count = 0;

        // 全てを空欄にし、種別をメモに戻す（関数にしても良いが、繰り返し利用次第）
        function reset(){
            $("#kind").val("メモ");
            $("#name").val("");
            $("#title").val("");
            $("#text_area").val("");
        }
        function canvas_reset(){
        }

        // ページ読み込み時の挙動を記載（以降、ボタン左から挙動を書いていく）
        $(function(){
            // 後ほど作るtableリストの削除も含まれるこれに
            localStorage.clear();
            $("body").fadeIn(4000);
        });

        //最初は選択してくださいから、各種別ごとに条件を分岐する
        $("#kind").change(function(){
            // 共通処理があれば、ここに記載

            if($("#kind").val() == "メモ"){
                // メモとしての初期処理

                //初期orお絵かきの途中から遷移した時の処理
                $("#h1").text("メモ帳");
                $("#color").remove();
                $("#range").remove();
                $("#detail").html('<textarea class="text_area" id="text_area" placeholder="入力はこちらです"></textarea>');   
                $("#menu_bar").append(
                    '<li id="new">書き換え</li>',
                    '<li id="renew" style="display:none;">更新</li>',
                    '<li id="save">保存</li>',
                    '<li id="clear">リセット</li>'
                );
                // canvas用のメニューバーを削除
                $("#canvas_new").remove();               
                $("#canvas_renew").remove();               
                $("#canvas_save").remove();               
                $("#canvas_clear").remove(); 
                // ----------------------------
                // メモのメニューバー処理
                // 書き換え処理
                $("#new").on("click",function(){
                    $("#name").val("");
                    $("#title").val("");
                    $("#text_area").val("");
                });
                // 保存処理
                $("#save").on("click",function(){
                    save_count ++;
                    const name = $("#name").val();
                    const title = $("#title").val();
                    const kind = $("#kind").val();
                    const text_area = $("#text_area").val();
                    // 全てが空欄の時は保存処理ができないよう
                    if (name!="" && title!="" && kind!="" && text_area!=""){
                        const memo_data = {        
                                "name":name,
                                "title":title,
                                "kind":kind,
                                "text_area":text_area
                        };           
                        // obj形式からjson形式に変更し、それをkey"Data"とし保存                
                        const m = JSON.stringify(memo_data);
                        localStorage.setItem(memo_data.title, m);
                        $("#back_menu").append($('<option>').html(memo_data.title).val(memo_data.title));
                        alert("保存が完了しました");
                        // 初期化する
                        reset();
                    }else{
                        // 空欄項目がある際の処理をelseで記載する
                        alert("入力が必要な項目があります")
                    }
                });

                // リセット処理は、指定したものだけリセットするかどうかを検討
                $("#clear").on("click",function(){ 
                    reset();
                    alert("削除しました");
                });

                // メモ一覧の中のセレクトボックスを選択した際の処理
                $("#back_menu").change(function(){
                    const memo_return = $("#back_menu").val();
                    console.log(memo_return);
                    const json = localStorage.getItem(memo_return);
                    const memo_data = JSON.parse(json);
                    // localデータに入れ子で登録したデータで複数データ保存ができるようにしている
                    $("#name").val(memo_data.name);
                    $("#title").val(memo_data.title);
                    $("#kind").val(memo_data.kind);
                    $("#text_area").val(memo_data.text_area);  

                    // メモ一覧を押したときだけ更新を出現する
                    $("#new").css("display","none");
                    $("#save").css("display","none");
                    $("#renew").css("display","block");

                    // 更新の処理について記載
                    // ★メモ一覧などを初期値に戻す 
                    $("#renew").on("click",function(){
                        const name = $("#name").val();
                        const title = $("#title").val();
                        const kind = $("#kind").val();
                        const text_area = $("#text_area").val();
                        const memo_data = {        
                                "name":name,
                                "title":title,
                                "kind":kind,
                                "text_area":text_area
                        };           
                        const m = JSON.stringify(memo_data);
                        // titleは変更が効かないようにしたい
                        localStorage.setItem(memo_data.title, m)

                        // 更新ボタンを外し、保存ボタンをつける
                        $("#new").css("display","block");
                        $("#save").css("display","block");
                        $("#renew").css("display","none");
                        alert("メモの更新が完了しました");
                        reset();
                    });
                })
                // ----------------------------
            }else if($("#kind").val() == "お絵かき"){
                // 初期orメモの途中から遷移した時の処理
                $("#h1").text("お絵かき帳");
                // canvasの設定、横幅の微調整についてはもう少しやってみたいところ
                $("#detail").html('<canvas id="drowarea" width="1400" height="500" style="border:1px solid #555;"></canvas>'); 
                $("#midashi").append(
                    '<input type="color" id="color" class="color">',
                    '<input type="range" id="range" class="range" value="15" min="1" max="30">'
                );
                $("#menu_bar").append(
                    '<li id="canvas_new">書き換え</li>',
                    '<li id="canvas_renew" style="display:none;">更新</li>',
                    '<li id="canvas_save">保存</li>',
                    '<li id="canvas_clear">リセット</li>'
                );
                // canvas用のメニューバーを削除
                $("#new").remove();               
                $("#renew").remove();               
                $("#save").remove();               
                $("#clear").remove();  
                //canvas初期設定
                let canvas_mouse_event = false; 
                let oldX = 0; //１つ前の座標を代入するための変数
                let oldY = 0; //１つ前の座標を代入するための変数
                let color = $("#color").val();
                let bold_line = $("#range").val();
                $("#color").on("change",function(){
                    color = $("#color").val();
                });
                $("#range").on("change",function(){
                    bold_line = $("#range").val();
                });
                const can = $("#drowarea")[0];
                const ctx = can.getContext("2d");

                //マウス動作中の処理、down（起点）→move（途中）、mouseup,mouseleave（終了、強制終了）
                $(can).on("mousedown",function(e){
                    oldX = e.offsetX;
                    oldY = e.offsetY;
                    canvas_mouse_event = true;
                    console.log(canvas_mouse_event);
                });
                $(can).on("mousemove",function(e){
                    if (canvas_mouse_event == true){
                        const px = e.offsetX;
                        const py = e.offsetY;
                        ctx.strokeStyle = color;
                        ctx.lineWidth = bold_line;
                        ctx.lineJoin = "round";
                        ctx.lineCap = "round";
                        ctx.beginPath();
                        ctx.moveTo(oldX,oldY);
                        ctx.lineTo(px,py);
                        ctx.stroke();
                        oldX = px;
                        oldY = py;
                    }   
                });
                $(can).on("mouseup",function(){
                    canvas_mouse_event = false;
                });
                $(can).on("mouseleave",function(){
                    canvas_mouse_event = false;
                });     
                // ----------------------------
                // canvasのメニューバー処理
                // 残課題
                // ・保存しているものの合計数などを表現するかどうかを考える
                // ・colorとrangeの初期値に書き換えと保存というかほぼ全てのボタンを押す時に初期値に戻す
                // 書き換え処理
                $("#canvas_new").on("click",function(){
                    ctx.beginPath();
                    ctx.clearRect(0,0,can.width,can.height)
                });
                $("#canvas_save").on("click",function(){
                    // この0が大事、意味はチューターさんに確認
                    const name = $("#name").val();
                    const title = $("#title").val();
                    const kind = $("#kind").val();
                    const canvas = $("#drowarea")[0];
                    const canvas_img = canvas.toDataURL("image/png");
                    const canvas_data = {        
                                "name":name,
                                "title":title,
                                "kind":kind,
                                "img_src":canvas_img
                    }
                    const c = JSON.stringify(canvas_data);
                    localStorage.setItem(canvas_data.title,c);
                    $("#canvas_back_menu").append($('<option>').html(canvas_data.title).val(canvas_data.title));
                    alert("画像保存しました");
                    // 初期化
                    ctx.beginPath();
                    ctx.clearRect(0,0,can.width,can.height)
                });

                $("#canvas_clear").on("click",function(){
                    ctx.beginPath();
                    ctx.clearRect(0,0,can.width,can.height)
                    alert("リセット完了です");
                });
                
                $("#canvas_back_menu").change(function(){
                    const canvas_return = $("#canvas_back_menu").val();
                    const canvas_return_img = localStorage.getItem(canvas_return);
                    const canvas_return_data = JSON.parse(canvas_return_img);
                    const canvas_final_return = canvas_return_data.img_src;
                    // 二回クリックしないいけない理由がわからないが、下に表示ボタンをつける
                    $("#h1").on("click",function(){
                        console.log(canvas_return_data);
                        console.log(canvas_final_return);
                        let ex_img = new Image();
                        ex_img.src = canvas_final_return;
                        ctx.drawImage(ex_img, 0, 0);
                        alert("前のデータを表示しました");
                    });
                    //表示するメニューの変更
                    $("#canvas_new").css("display","none");
                    $("#canvas_save").css("display","none");
                    $("#canvas_renew").css("display","block");
                    
                    $("#canvas_renew").on("click",function(){
                        const name = $("#name").val();
                        const title = $("#title").val();
                        const kind = $("#kind").val();
                        const canvas = $("#drowarea")[0];
                        const canvas_img = canvas.toDataURL("image/png");
                        const canvas_data = {        
                                    "name":name,
                                    "title":title,
                                    "kind":kind,
                                    "img_src":canvas_img
                        }
                        const c = JSON.stringify(canvas_data);
                        // titleは変更が効かないようにしたい
                        localStorage.setItem(canvas_data.title,c);
                        alert("お絵かきの更新が完了しました");
                        // 更新タイミンで消したボタンの復活（renewとclear、メモへの変更で行う）
                        $("#canvas_new").css("display","block");
                        $("#canvas_save").css("display","block");
                        $("#canvas_back").css("display","block");
                        $("#canvas_renew").css("display","none");
                        ctx.beginPath();
                        ctx.clearRect(0,0,can.width,can.height) 
                    });
                });    
                // ----------------------------
            }
        });
            
        

        

        // table表示の部分についての記載
        for(let i=0; i<localStorage.length; i++){
            
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);

        }

    </script>
</body>

</html>