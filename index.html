<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>myMemoPad</title>
    <!-- <script src="js/jquery-2.1.3.min.js"></script> -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/sample.css">
</head>

<body style="display:none;">
    <header>
        <h1 id="h1">メモ帳</h1>
    </header>

    <main>
        <div class="memo" id="memo">
            <textarea class="name" id="name" placeholder="氏名" cols="15" rows="1" maxlength="15"></textarea>
            <div class="midashi" id="midashi">
                <textarea class="title" id="title" placeholder="タイトル" cols="30" rows="1" maxlength="15"></textarea>
                <select class="kind" id="kind" name="kind">
                    <option value="hidden" hidden>種別</option>
                    <option value="メモ">メモ</option>
                    <option value="お絵かき">お絵かき</option>
                    <option value="リスト削除">リスト削除</option>
                </select>
                <!-- メニューバーから外し、セレクトボックスを統一する -->
                <select class="back" id="back_menu" name="back" style="display: none;">
                    <option value="memo_list" hidden>メモ一覧</option>
                </select>
                <select class="back" id="canvas_back_menu" name="back" style="display: none;">
                    <option value="picture_list" hidden>お絵かき一覧</option>
                </select>
            </div>
            <div class="detail" id="detail">
            <textarea class="text_area" id="text_area" placeholder="入力はこちらです"></textarea>
            </div>
        </div>
        <ul id="menu_bar">
            <!-- ここには別のところから差し込む -->
        </ul>
        <div class="list_table">
            <table id="list">
            <tr><th>タイトル</th><th>氏名</th><th>種別</th></tr>
            </table>
        </div>
    </main>

    <!-- jQueryの読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- jQueryの記述 -->
    <script>
        // 課題
        // clearタイミングでtableも削除できるようにする、tableの条件分岐

        // 初期設定する変数などはこちらで
        let save_count = 0;

        function reset(){
            $("#name").val("");
            $("#title").val("");
            $("#text_area").val("");
            $("#back_menu").css("display","none");
            $("#canvas_back_menu").css("display","none");
            $("#kind").val("hidden");
        }
        function menu_bar_delete(){
            $("#new").remove();               
            $("#show").remove();               
            $("#renew").remove();               
            $("#save").remove();               
            $("#clear").remove(); 
        }
        function canvas_menu_bar_delete(){
            $("#canvas_new").remove();               
            $("#canvas_show").remove();               
            $("#canvas_renew").remove();               
            $("#canvas_save").remove();               
            $("#canvas_clear").remove(); 
        }
        function list_make(){
            for(let i=0; i<localStorage.length; i++){
                // localstorageにおける順番をもとにkeyを取り出す
                const key = localStorage.key(i);
                // そのkeyをもとにlocalstorageのデータを取り出す
                const list_data = localStorage.getItem(key);
                // 取り出したデータをobj形式に変換する 
                const list_return_data = JSON.parse(list_data);
                // tableの処理を記載する
                // 取り出したデータをもとにtable行を生成し、そいつをtableに追加
                const html = '<tr><th>'+list_return_data.title+'</th><th>'+list_return_data.name+'</th><th>'+list_return_data.kind+'</th></tr>';
                $("#list").append(html);
                // リロード時にメモ一覧とお絵かき一覧が消えていると微妙なので、それを記載
                // 今回種別がメモとそうじゃないものがいるので、それぞれ別の格納場所に保管する
                if (list_return_data.kind=="メモ"){
                    $("#back_menu").append($('<option>').html(list_return_data.title).val(list_return_data.title));
                }else{
                    $("#canvas_back_menu").append($('<option>').html(list_return_data.title).val(list_return_data.title));
                }
            }
        }
        // ページ読み込み時の挙動を記載（以降、ボタン左から挙動を書いていく）
        $(function(){
            $("body").fadeIn(4000);
        });

        //最初は選択してくださいから、各種別ごとに条件を分岐する
        $("#kind").change(function(){

            if($("#kind").val() == "メモ"){
                $("#back_menu").css("display","block");
                $("#back_menu").val("memo_list");
                $("#canvas_back_menu").css("display","none");
                $("#h1").text("メモ帳");
                // この処理は仮に何もボタンを押さずに、種別変更した際の保険（メモと削除にはつける）
                canvas_menu_bar_delete();
                $("#color").remove();
                $("#range").remove();
                // テキストエリアを追加する（htmlで設定しているのでtextareaで上書きする）
                $("#detail").html('<textarea class="text_area" id="text_area" placeholder="入力はこちらです"></textarea>');   
                // メモ用の各種処理ボックスを追加する
                $("#menu_bar").append(
                    '<li id="new">書き換え</li>',
                    '<li id="show" style="display:none;">表示</li>',
                    '<li id="renew" style="display:none;">更新</li>',
                    '<li id="save">保存</li>',
                    '<li id="clear" style="display:none;">リセット</li>'
                );
                // 書き換え（new）での処理（名前とタイトルだけ残すためresetは利用していない）
                // 全ての値を空欄にし、種別をhiddenに戻す（changeが使えるようにする）
                $("#new").on("click",function(){
                    $("#text_area").val("");
                    // menu_bar_delete();
                    // $("#kind").val("hidden");
                });
                // 保存（save）での処理
                $("#save").on("click",function(){
                    save_count ++;
                    const name = $("#name").val();
                    const title = $("#title").val();
                    const kind = $("#kind").val();
                    const text_area = $("#text_area").val();
                    const memo_data = {        
                                "name":name,
                                "title":title,
                                "kind":kind,
                                "text_area":text_area
                        };           
                    const m = JSON.stringify(memo_data);
                    if (name!="" && title!="" && kind!="" && text_area!=""){
                        localStorage.setItem(memo_data.title, m);
                        // メモ一覧にkeyをvalue、htmlとするselectboxを生成する 
                        $("#back_menu").append($('<option>').html(memo_data.title).val(memo_data.title));
                        // tableの処理を記載する
                        const html = '<tr value='+memo_data.title+'><th>'+memo_data.title+'</th><th>'+memo_data.name+'</th><th>'+memo_data.kind+'</th></tr>';
                        $("#list").append(html);
                        // 一番最初のページに戻る処理
                        menu_bar_delete();
                        $("#back_menu").css("display","none");
                        alert("保存します");
                        reset();
                    }else{
                        // 全てが空欄である時にエラーが出るようにする（保存処理もできない）
                        alert("入力が必要な項目があります");
                    }
                });
                // メモ一覧の中のセレクトボックスを選択した際の処理
                $("#back_menu").change(function(){
                    // メモ一覧を押した時に、更新とリセットだけにする
                    $("#new").css("display","none");
                    $("#save").css("display","none");
                    $("#show").css("display","block");
                    // 変更する下2行
                    $("#renew").css("display","none");
                    $("#clear").css("display","none");
                    // メニュー一覧のvalueを取り出し、obj形式に変換した上で表示する
                    const memo_return = $("#back_menu").val();
                    const json = localStorage.getItem(memo_return);
                    const memo_data = JSON.parse(json);
                    // localデータに入れ子で登録したデータで複数データ保存ができるようにしている
                    $("#show").on("click",function(){
                        // showを押した時だけrenewとclearが可能にする
                        $("#show").css("display","none");
                        $("#renew").css("display","block");
                        $("#clear").css("display","block");
                        // このタイミングでは、menu_barには変更させない（この後の処理に更新orリセットor種別変更が考えられる）
                        $("#name").val(memo_data.name);
                        $("#title").val(memo_data.title);
                        $("#kind").val(memo_data.kind);
                        $("#text_area").val(memo_data.text_area);

                    $("#renew").on("click",function(){
                        // saveと同じ挙動を実行（menu_barでの差分だけ埋める）
                        const name = $("#name").val();
                        const title = $("#title").val();
                        const kind = $("#kind").val();
                        const text_area = $("#text_area").val();
                        const memo_data = {        
                                "name":return_name,
                                "title":return_title,
                                "kind":return_kind,
                                "text_area":return_text_area
                        };           
                        const m = JSON.stringify(memo_data);
                        localStorage.setItem(memo_data.title, m);
                        const html = '<tr value='+memo_data.title+'><th>'+memo_data.title+'</th><th>'+memo_data.name+'</th><th>'+memo_data.kind+'</th></tr>';
                        // 追加：取得してきたものとタイトルが違う時だけ更新が可能とする
                        $("#list").append(html);
                        menu_bar_delete();
                        $("#back_menu").css("display","none");
                        alert("メモの更新が完了します");
                        reset();
                        
                    });
                })
                // 更新の処理について記載
                
                $("#clear").on("click",function(){
                        // localstorageについて、選択したメモ一覧のvalueをキーに削除
                        localStorage.removeItem(memo_return);
                        // メモ一覧について、選択したメモ一覧のvalueをキーに削除
                        const selectbox = $('select[id=back_menu]');
                        selectbox.children('option[value='+memo_return+']').remove();
                        // tableからの削除（検証中）
                        menu_bar_delete();
                        $("#back_menu").css("display","none");
                        alert("削除します");
                        reset();
                        // tableを作る
                        list_make();
                });  

            });
                // ----------------------------
            }else if($("#kind").val() == "お絵かき"){
                $("#canvas_back_menu").css("display","block");
                $("#canvas_back_menu").val("picture_list"); 
                $("#back_menu").css("display","none");
                // 初期orメモの途中から遷移した時の処理
                $("#h1").text("お絵かき帳");
                // canvasの設定をする（htmlで設定しているのでtextareaで上書きする）
                $("#detail").html('<canvas id="drowarea" width="1400" height="500" style="border:1px solid #555;"></canvas>'); 
                // canvas用のメニューバーを削除
                menu_bar_delete();
                // カラーパレットとrangeを追加する
                $("#midashi").append(
                    '<input type="color" id="color" class="color">',
                    '<input type="range" id="range" class="range" value="15" min="1" max="30">'
                );
                // メモ用の各種処理ボックスを追加する
                $("#menu_bar").append(
                    '<li id="canvas_new">書き換え</li>',
                    '<li id="canvas_show" style="display:none;">表示</li>',
                    '<li id="canvas_renew" style="display:none;">更新</li>',
                    '<li id="canvas_save">保存</li>',
                    '<li id="canvas_clear" style="display:none;">リセット</li>'
                );
                //canvas初期設定
                let canvas_mouse_event = false; 
                const can = $("#drowarea")[0];
                const ctx = can.getContext("2d");
                let oldX = 0; //１つ前の座標を代入するための変数
                let oldY = 0; //１つ前の座標を代入するための変数
                let color = $("#color").val();
                let bold_line = $("#range").val();
                $("#color").on("change",function(){
                    color = $("#color").val();
                });
                $("#range").on("change",function(){
                    bold_line = $("#range").val();
                });
                $(can).on("mousedown",function(e){
                    oldX = e.offsetX;
                    oldY = e.offsetY;
                    canvas_mouse_event = true;
                    console.log(canvas_mouse_event);
                });
                $(can).on("mousemove",function(e){
                    if (canvas_mouse_event == true){
                        const px = e.offsetX;
                        const py = e.offsetY;
                        ctx.strokeStyle = color;
                        ctx.lineWidth = bold_line;
                        ctx.lineJoin = "round";
                        ctx.lineCap = "round";
                        ctx.beginPath();
                        ctx.moveTo(oldX,oldY);
                        ctx.lineTo(px,py);
                        ctx.stroke();
                        oldX = px;
                        oldY = py;
                    }   
                });
                // mouseleaveとmouseupがする時の処理
                $(can).on("mouseup",function(){
                    canvas_mouse_event = false;
                });
                $(can).on("mouseleave",function(){
                    canvas_mouse_event = false;
                });    
                // 書き換え（canvas_new）での処理（名前とタイトルだけ残すためresetは利用していない）
                // 全ての値を空欄にし、種別をhiddenに戻す（changeが使えるようにする）
                // colorとrangeの初期値に書き換えと保存というかほぼ全てのボタンを押す時に初期値に戻す
                $("#canvas_new").on("click",function(){
                    // colorとrangeの初期化
                    let color = $("#color").val("#333333");
                    let bold_line = $("#range").val(15);
                    // canvasをきれいにし、種別をhiddenにしたい
                    ctx.beginPath();
                    ctx.clearRect(0,0,can.width,can.height);
                    canvas_menu_bar_delete();
                    $("#kind").val("hidden");
                });
                $("#canvas_save").on("click",function(){
                    // この0が大事、意味はチューターさんに確認
                    // 画像をbase64に変換し、obj形式を定義し、Jsonに変換・保存する
                    const name = $("#name").val();
                    const title = $("#title").val();
                    const kind = $("#kind").val();
                    const canvas = $("#drowarea")[0];
                    const canvas_img = canvas.toDataURL("image/png");
                    const canvas_data = {        
                                "name":name,
                                "title":title,
                                "kind":kind,
                                "img_src":canvas_img
                    }
                    const c = JSON.stringify(canvas_data);
                    localStorage.setItem(canvas_data.title,c);
                    // メモ一覧にkeyをvalue、htmlとするselectboxを生成する 
                    $("#canvas_back_menu").append($('<option>').html(canvas_data.title).val(canvas_data.title));
                    // tableの処理を記載する
                    const html = '<tr value='+canvas_data.title+'><th>'+canvas_data.title+'</th><th>'+canvas_data.name+'</th><th>'+canvas_data.kind+'</th></tr>';
                    $("#list").append(html);
                    // saveした後の処理を記載する、toolや中身に関して
                    let color = $("#color").val("#333333");
                    let bold_line = $("#range").val(15);
                    $("#color").remove();
                    $("#range").remove();
                    $("#name").val("");
                    $("#title").val("");
                    ctx.beginPath();
                    ctx.clearRect(0,0,can.width,can.height);
                    // canvas_menu_barの削除
                    canvas_menu_bar_delete();
                    // canvas_backmenuが削除されるようにする
                    $("#canvas_back_menu").css("display","none");
                    alert("画像保存します");
                    $("#kind").val("hidden");
                });
                
                $("#canvas_back_menu").change(function(){
                    // メモ一覧を押した時に、更新とリセットだけにする
                    $("#canvas_new").css("display","none");
                    $("#canvas_save").css("display","none");
                    $("#canvas_show").css("display","block");
                    $("#canvas_renew").css("display","block");
                    $("#canvas_clear").css("display","block");
                    // メニュー一覧のvalueを取り出し、obj形式に変換した上で表示する（base64の処理を加えている）
                    const canvas_return = $("#canvas_back_menu").val();
                    const canvas_return_img = localStorage.getItem(canvas_return);
                    const canvas_return_data = JSON.parse(canvas_return_img);
                    const canvas_final_return = canvas_return_data.img_src;
                    // 二回クリックしないいけない問題が表示している
                    $("#canvas_show").on("click",function(){
                        // まず画面を初期化する
                        ctx.beginPath();
                        ctx.clearRect(0,0,can.width,can.height);
                        // 画像を表示する
                        let ex_img = new Image();
                        ex_img.src = canvas_final_return;
                        ctx.drawImage(ex_img, 0, 0);
                        // 他項目を表示する
                        $("#name").val(canvas_return_data.name);
                        $("#title").val(canvas_return_data.title);
                        $("#kind").val(canvas_return_data.kind);
                    });
                    $("#canvas_renew").on("click",function(){
                        // saveと同じ挙動を実行（menu_barでの差分だけ埋める）
                        const name = $("#name").val();
                        const title = $("#title").val();
                        const kind = $("#kind").val();
                        const canvas = $("#drowarea")[0];
                        const canvas_img = canvas.toDataURL("image/png");
                        const canvas_data = {        
                                    "name":name,
                                    "title":title,
                                    "kind":kind,
                                    "img_src":canvas_img
                        }
                        const c = JSON.stringify(canvas_data);
                        localStorage.setItem(canvas_data.title,c);
                        const html = '<tr value='+canvas_data.title+'><th>'+canvas_data.title+'</th><th>'+canvas_data.name+'</th><th>'+canvas_data.kind+'</th></tr>';
                        $("#list").append(html);

                        let color = $("#color").val("#333333");
                        let bold_line = $("#range").val(15);
                        $("#color").remove();
                        $("#range").remove();
                        $("#name").val("");
                        $("#title").val("");
                        ctx.beginPath();
                        ctx.clearRect(0,0,can.width,can.height);
                        canvas_menu_bar_delete();
                        $("#canvas_back_menu").css("display","none");
                        alert("お絵かきの更新が完了します");
                        $("#kind").val("hidden");
                    });
                    $("#canvas_clear").on("click",function(){
                        // localstorageについて、選択したメモ一覧のvalueをキーに削除
                        localStorage.removeItem(canvas_return);
                        // メモ一覧について、選択したメモ一覧のvalueをキーに削除
                        const selectbox = $('select[id=canvas_back_menu]');
                        selectbox.children('option[value='+canvas_return+']').remove();
                        // tableを消去する処理が必要
                        $("#list").remove(canvas_return);
                        let color = $("#color").val("#333333");
                        let bold_line = $("#range").val(15);
                        $("#color").remove();
                        $("#range").remove();
                        $("#name").val("");
                        $("#title").val("");
                        ctx.beginPath();
                        ctx.clearRect(0,0,can.width,can.height);
                        canvas_menu_bar_delete();
                        $("#canvas_back_menu").css("display","none");
                        alert("リセット完了します");
                        $("#kind").val("hidden");
                    });  
                });
            }else if($("#kind").val() == "リスト削除"){
                // 全メニューボックスの削除を実行（最後に書くとダメ）
                $("#menu_bar").empty();
                $("#back_menu").css("display","none");
                $("#canvas_back_menu").css("display","none");
                // canvasの定義を入れた
                const can = $("#drowarea")[0];
                const ctx = can.getContext("2d");
                ctx.beginPath();
                ctx.clearRect(0,0,can.width,can.height);
                // リストの中身をヘッターだけにする
                $("#list").html('<tr><th>タイトル</th><th>氏名</th><th>種別</th></tr>');
                // ローカルストレージをきれいにする
                localStorage.clear();
                // お絵かきのツールたちへの処理
                let color = $("#color").val("#333333");
                let bold_line = $("#range").val(15);
                $("#color").remove();
                $("#range").remove();
                // 最初のページに戻す処理
                $("#name").val("");
                $("#title").val("");
                alert("list一覧を削除します");
                $("#kind").val("hidden");
            }else{
                // 考慮漏れ用
                alert("考慮漏れがあるよ");
            }
        });

        list_make();
            
    </script>
</body>

</html>